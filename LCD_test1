#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Preferences.h>

// Orange = SDA (21), Yellow = SCL (22)
LiquidCrystal_I2C lcd(0x27, 16, 2);
Preferences prefs;

// Store previous values to prevent redundant writing (The "Anti-Flicker" Logic)
int lastHA, lastSA, lastTA, lastHB, lastSB;
bool lastPump;
unsigned long lastUpdate = 0;

void setup() {
  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();
  lcd.clear();

  // Print STATIC LABELS once. These never move.
  lcd.setCursor(0, 0); lcd.print("A:H.... S... ..C");
  lcd.setCursor(0, 1); lcd.print("B:H.... S...    ");

  prefs.begin("irrigation", false);
}

void loop() {
  // Update sensors every 500ms to meet "System Validation" requirements [cite: 28, 29]
  if (millis() - lastUpdate > 500) {
    lastUpdate = millis();

    // INPUTS: Replace these with your actual sensor variables
    int hA = 2450; int sA = 420; int tA = 22; 
    int hB = 2150; int sB = 380; bool pumpB = false;

    // --- TESTBED A UPDATES ---
    if (hA != lastHA) { lcd.setCursor(3, 0); lcd.print(pad(hA, 4)); lastHA = hA; }
    if (sA != lastSA) { lcd.setCursor(9, 0); lcd.print(pad(sA, 3)); lastSA = sA; }
    if (tA != lastTA) { lcd.setCursor(13, 0); lcd.print(pad(tA, 2)); lastTA = tA; }

    // --- TESTBED B UPDATES ---
    if (hB != lastHB) { lcd.setCursor(3, 1); lcd.print(pad(hB, 4)); lastHB = hB; }
    if (sB != lastSB) { lcd.setCursor(9, 1); lcd.print(pad(sB, 3)); lastSB = sB; }
    
    // Pump Status Toggle
    if (pumpB != lastPump) {
      lcd.setCursor(13, 1);
      lcd.print(pumpB ? "ON " : "OFF");
      lastPump = pumpB;
    }

    // Heartbeat: Always flickers one character to show "Full system functionality" 
    static bool hb = false;
    lcd.setCursor(12, 1);
    lcd.print(hb ? "*" : " ");
    hb = !hb;
  }
}

// Helper to prevent "ghost digits" (e.g., 1000 becoming 9990)
String pad(int val, int width) {
  String s = String(val);
  while (s.length() < width) s = " " + s; 
  return s;
}
