#include <esp_now.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Preferences.h>

// Initialize LCD
LiquidCrystal_I2C lcd(0x27, 16, 2); 
Preferences prefs;

const char* ssid = "ESP32-Hub";
const char* password = "password123";
WebServer server(80);

// Structure must match V2_Sensor.ino exactly [cite: 3, 45]
typedef struct struct_message {
  int id;
  float temp;
  float hum;
  int battery;
  float batteryVoltage;
  int moistureRaw;
  int soilmoisture;
} struct_message;

struct_message boardsStruct[4];

// Zero-Flicker Tracking Variables
int lastHB_Moist = -1;
int lastHB_Raw = -1;
bool hbState = false;
unsigned long lastLCDUpdate = 0;

// --- FIXED ESP-NOW CALLBACK FOR VERSION 3.0+ ---
// The first argument is now a pointer to esp_now_recv_info_t
void OnDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len) {
  struct_message incomingReadings;
  memcpy(&incomingReadings, incomingData, sizeof(incomingReadings));
  
  // Store data based on ID [cite: 8, 9]
  int index = incomingReadings.id - 1;
  if (index >= 0 && index < 4) {
    boardsStruct[index] = incomingReadings;
  }
}

// --- HTML WEBPAGE ---
String getHTML() {
  String html = "<!DOCTYPE html><html><head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">";
  html += "<meta http-equiv=\"refresh\" content=\"2\"><style>body { font-family: Arial; text-align: center; }";
  html += "table { margin: auto; border-collapse: collapse; width: 90%; } td, th { border: 1px solid #ddd; padding: 8px; }</style></head><body>";
  html += "<h1>ESP32 Sensor Hub</h1><table><tr><th>Board ID</th><th>Moisture (%)</th><th>Moisture Raw</th><th>Voltage</th></tr>";
  
  for (int i = 0; i < 4; i++) {
    html += "<tr><td>Board " + String(i+1) + "</td>";
    html += "<td>" + String(boardsStruct[i].soilmoisture) + "%</td>";
    html += "<td>" + String(boardsStruct[i].moistureRaw) + "</td>";
    html += "<td>" + String(boardsStruct[i].batteryVoltage, 2) + "V</td></tr>";
  }
  html += "</table></body></html>";
  return html;
}

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22); // Orange=SDA, Yellow=SCL
  
  lcd.init();
  lcd.backlight();
  lcd.clear();
  
  // Initial Labels
  lcd.setCursor(0, 0); lcd.print("A:H.... S... ..C");
  lcd.setCursor(0, 1); lcd.print("B:H.... S...    ");

  WiFi.mode(WIFI_AP_STA);
  WiFi.softAP(ssid, password);

  // Initialize ESP-NOW [cite: 38]
  if (esp_now_init() != ESP_OK) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }
  
  // Register the fixed callback
  esp_now_register_recv_cb(OnDataRecv);

  server.on("/", [](){ server.send(200, "text/html", getHTML()); });
  server.begin();
}

void loop() {
  server.handleClient();

  // Update LCD every 500ms without clearing
  if (millis() - lastLCDUpdate > 500) {
    lastLCDUpdate = millis();
    hbState = !hbState;

    // Use Board 1 (XIAO) data for Bed B display
    int currentMoist = boardsStruct[0].soilmoisture;
    int currentRaw = boardsStruct[0].moistureRaw;

    // Only update if values change (Anti-Flicker)
    if (currentMoist != lastHB_Moist) {
      lcd.setCursor(3, 1);
      lcd.print(pad(currentMoist, 4)); 
      lastHB_Moist = currentMoist;
    }

    if (currentRaw != lastHB_Raw) {
      lcd.setCursor(9, 1);
      lcd.print(pad(currentRaw, 3));
      lastHB_Raw = currentRaw;
    }

    // Heartbeat
    lcd.setCursor(12, 1);
    lcd.print(hbState ? "*" : " ");
  }
}

String pad(int val, int width) {
  String s = String(val);
  while (s.length() < width) s = " " + s;
  return s;
}
