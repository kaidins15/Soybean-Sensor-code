/*
 * RECEIVER HUB CODE (Freenove ESP32)
 * 1. Creates Wi-Fi AP "ESP32-Hub"
 * 2. Receives ESP-NOW data from Seeed XIAO
 * 3. Hosts Web Server & Updates Zero-Flicker LCD
 */
#include <esp_now.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// --- LCD CONFIGURATION ---
// Orange = SDA (GPIO 21), Yellow = SCL (GPIO 22)
LiquidCrystal_I2C lcd(0x27, 16, 2); 

const char* ssid = "ESP32-Hub";
const char* password = "password123";

WebServer server(80);

// Structure MUST match V2_Sensor.ino 
typedef struct struct_message {
  int id;
  float temp;
  float hum;
  int battery;
  float batteryVoltage;
  int moistureRaw;
  int soilmoisture;
} struct_message;

struct_message boardsStruct[4];

// Zero-Flicker Tracking Variables
int lastHB_Moist = -1;
int lastHB_Sal = -1;
bool hbState = false;
unsigned long lastLCDUpdate = 0;

// --- ESP-NOW CALLBACK ---
void OnDataRecv(const uint8_t * mac, const uint8_t *incomingData, int len) {
  struct_message incomingReadings;
  memcpy(&incomingReadings, incomingData, sizeof(incomingReadings));
  
  int index = incomingReadings.id - 1; [cite: 8]
  if (index >= 0 && index < 4) {
    boardsStruct[index] = incomingReadings; [cite: 9]
  }
}

// --- HTML WEBPAGE ---
String getHTML() {
  String html = "<!DOCTYPE html><html><head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">"; [cite: 16, 17]
  html += "<meta http-equiv=\"refresh\" content=\"2\"><style>body { font-family: Arial; text-align: center; }"; [cite: 17, 18]
  html += "table { margin: auto; border-collapse: collapse; width: 90%; } td, th { border: 1px solid #ddd; padding: 8px; }</style></head><body>"; [cite: 19, 20]
  html += "<h1>ESP32 Sensor Hub</h1><table><tr><th>Board</th><th>Moisture (%)</th><th>Raw</th><th>Voltage</th></tr>"; [cite: 22]
  
  for (int i = 0; i < 4; i++) {
    html += "<tr><td>Board " + String(i+1) + "</td>"; [cite: 24]
    html += "<td>" + String(boardsStruct[i].soilmoisture) + "%</td>"; [cite: 28]
    html += "<td>" + String(boardsStruct[i].moistureRaw) + "</td>"; [cite: 27]
    html += "<td>" + String(boardsStruct[i].batteryVoltage, 2) + "V</td></tr>"; [cite: 27]
  }
  html += "</table></body></html>";
  return html;
}

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22); // Orange/Yellow pins
  
  // LCD Initialization
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("A:H.... S... ..C");
  lcd.setCursor(0, 1); lcd.print("B:H.... S...    ");

  WiFi.mode(WIFI_AP_STA); [cite: 36]
  WiFi.softAP(ssid, password); [cite: 37]

  if (esp_now_init() != ESP_OK) { return; } [cite: 38, 39]
  esp_now_register_recv_cb(esp_now_recv_cb_t(OnDataRecv)); [cite: 39]

  server.on("/", [](){ server.send(200, "text/html", getHTML()); }); [cite: 40]
  server.begin();
}

void loop() {
  server.handleClient(); [cite: 41]

  // Zero-Flicker LCD Update (Every 500ms)
  if (millis() - lastLCDUpdate > 500) {
    lastLCDUpdate = millis();
    hbState = !hbState;

    // Bed B Data from Board 1 (XIAO) [cite: 44, 55]
    int currentMoist = boardsStruct[0].soilmoisture;
    int currentRaw = boardsStruct[0].moistureRaw;

    // Only update the LCD if values have changed to prevent flickering
    if (currentMoist != lastHB_Moist) {
      lcd.setCursor(3, 1);
      lcd.print(pad(currentMoist, 4)); 
      lastHB_Moist = currentMoist;
    }

    if (currentRaw != lastHB_Sal) {
      lcd.setCursor(9, 1);
      lcd.print(pad(currentRaw, 3));
      lastHB_Sal = currentRaw;
    }

    // Heartbeat Indicator
    lcd.setCursor(12, 1);
    lcd.print(hbState ? "*" : " ");
  }
}

String pad(int val, int width) {
  String s = String(val);
  while (s.length() < width) s = " " + s;
  return s;
}
